{
    "version": "https://jsonfeed.org/version/1",
    "title": "SnowRoll Blog • All posts by \"except\" tag",
    "description": "分享经验，记录生活",
    "home_page_url": "https://snowroll.github.io",
    "items": [
        {
            "id": "https://snowroll.github.io/shell-except/",
            "url": "https://snowroll.github.io/shell-except/",
            "title": "shell-except",
            "date_published": "2020-10-21T14:57:55.000Z",
            "content_html": "<h3 id=\"内容摘要\"><a class=\"markdownIt-Anchor\" href=\"#内容摘要\">#</a> 内容摘要</h3>\n<ul>\n<li>except 简介</li>\n<li>利用 except，向服务器传输文件 &amp; ssh 登录服务器</li>\n</ul>\n<a id=\"more\"></a>\n<h4 id=\"1-except简介\"><a class=\"markdownIt-Anchor\" href=\"#1-except简介\">#</a> 1. except 简介</h4>\n<ul>\n<li>\n<p>except 的安装</p>\n<p>Mac:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">brew install expect</span><br></pre></td></tr></table></figure>\n<p>Linux:</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">apt install expect</span><br></pre></td></tr></table></figure>\n<p>压缩包安装</p>\n<p>参考博客： <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC85NDJiODAxNzU3ZGU=\">https://www.jianshu.com/p/942b801757de</span></p>\n</li>\n<li>\n<p>简介</p>\n<p>shell 脚本功能非常强大，可以帮助我们自动完成很多繁琐的工作。但是对于登录服务器这种需要自动交互的过程，shell 就有些力不从心，except 可以完美解决这一需求。</p>\n<p>参考博客： Linux expect 用法 <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuY25ibG9ncy5jb20vMHhjYWZlZGFkZHkvcC83MTQ3MDUxLmh0bWw=\">https://www.cnblogs.com/0xcafedaddy/p/7147051.html</span></p>\n<p>expect 脚本使用 <span class=\"exturl\" data-url=\"aHR0cDovL2VpbnZlcm5lLmdpdGh1Yi5pby9wb3N0LzIwMTkvMDEvZXhwZWN0LWNvbW1hbmQuaHRtbCMlRTUlODUlQjMlRTklOTQlQUUlRTUlOTElQkQlRTQlQkIlQTQ=\">http://einverne.github.io/post/2019/01/expect-command.html# 关键命令</span></p>\n<p>expect - 自动交互脚本 <span class=\"exturl\" data-url=\"aHR0cDovL3hzdGFyY2QuZ2l0aHViLmlvL3dpa2kvc2hlbGwvZXhwZWN0Lmh0bWw=\">http://xstarcd.github.io/wiki/shell/expect.html</span></p>\n<ul>\n<li>\n<p>四个重要的命令</p>\n<table>\n<thead>\n<tr>\n<th>命令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>spawn</td>\n<td>启动新的进程，输出可以被 expect 所捕获</td>\n</tr>\n<tr>\n<td>expect</td>\n<td>从进程接收字符串，期望获得字符串</td>\n</tr>\n<tr>\n<td>send</td>\n<td>向进程发送字符串，模拟用户输入，注意添加 <code>\\r</code>  回车</td>\n</tr>\n<tr>\n<td>interact</td>\n<td>允许用户与进程交互</td>\n</tr>\n</tbody>\n</table>\n</li>\n<li>\n<p>简单示例  <code>demo.sh</code></p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/usr/bin/except</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">set</span> timeout 10;  <span class=\"comment\"># 设置程序超时时间</span></span><br><span class=\"line\">spawn ssh root@10.10.10.11  <span class=\"comment\"># ssh连接服务器</span></span><br><span class=\"line\">expect <span class=\"string\">&quot;password&quot;</span>  <span class=\"comment\"># 判断进程输出中是否有&quot;password&quot;</span></span><br><span class=\"line\">send <span class=\"string\">&quot;your_password\\r&quot;</span>  <span class=\"comment\"># 将密码输入 \\r是回车 </span></span><br><span class=\"line\">interact  <span class=\"comment\"># 保持与服务器端的连接</span></span><br></pre></td></tr></table></figure>\n<p>运行方法:  <code>except demo.sh</code></p>\n<p>\\r \\n 的区别： <span class=\"exturl\" data-url=\"aHR0cHM6Ly93d3cuamlhbnNodS5jb20vcC8yMzgwNGIwYjAzYzg=\">https://www.jianshu.com/p/23804b0b03c8</span></p>\n</li>\n</ul>\n</li>\n</ul>\n<h4 id=\"2-向服务器传输文件ssh登录服务器自动化脚本\"><a class=\"markdownIt-Anchor\" href=\"#2-向服务器传输文件ssh登录服务器自动化脚本\">#</a> 2. 向服务器传输文件 &amp; ssh 登录服务器自动化脚本</h4>\n<ul>\n<li>\n<p>except 与 shell 脚本结合</p>\n<figure class=\"highlight sh\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"meta\">#!/bin/bash</span></span><br><span class=\"line\"><span class=\"meta\">#!/usr/bin/expect</span></span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># 自动上传文件到服务器</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">auto_scp</span></span>()&#123;</span><br><span class=\"line\">\t\t<span class=\"comment\"># -c: 执行脚本前先执行的命令</span></span><br><span class=\"line\">    expect -c <span class=\"string\">&quot;set timeout -1; </span></span><br><span class=\"line\"><span class=\"string\">            spawn scp yourfile root@10.10.10.10:/target_dir/</span></span><br><span class=\"line\"><span class=\"string\">            expect &#123;</span></span><br><span class=\"line\"><span class=\"string\">                \\&quot;yes/no\\&quot; &#123; send \\&quot;yes\\n\\&quot;; exp_continue&#125;</span></span><br><span class=\"line\"><span class=\"string\">                \\&quot;password\\&quot; &#123; send \\&quot;yourpasswd\\n\\&quot; &#125;  # \\n 和 \\r 均可以</span></span><br><span class=\"line\"><span class=\"string\">            &#125;</span></span><br><span class=\"line\"><span class=\"string\">            interact</span></span><br><span class=\"line\"><span class=\"string\">            &quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\"># ssh登录服务器</span></span><br><span class=\"line\"><span class=\"function\"><span class=\"title\">auto_ssh_restart</span></span>() &#123;</span><br><span class=\"line\">    expect -c <span class=\"string\">&quot;set timeout -1;</span></span><br><span class=\"line\"><span class=\"string\">            spawn ssh root@10.10.10.10</span></span><br><span class=\"line\"><span class=\"string\">            expect \\&quot;password\\&quot; </span></span><br><span class=\"line\"><span class=\"string\">            send \\&quot;yourpassword\\r\\&quot;</span></span><br><span class=\"line\"><span class=\"string\">            expect \\&quot;]#\\&quot; &#123; send \\&quot;pwd\\n\\&quot; &#125; </span></span><br><span class=\"line\"><span class=\"string\">            interact&quot;</span></span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\">auto_scp</span><br><span class=\"line\">auto_ssh_restart</span><br></pre></td></tr></table></figure>\n</li>\n</ul>\n<center>点绛唇·途中逢管倅\n<center> 憔悴天涯，故人相遇情如故。别离何遽，忍唱阳关句！</center>\n<center>我是行人，更送行人去。愁无据。寒蝉鸣处，回首斜阳暮。</center>\n",
            "tags": [
                "linux",
                "shell",
                "except"
            ]
        }
    ]
}